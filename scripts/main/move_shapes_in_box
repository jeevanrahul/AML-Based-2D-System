import ezdxf

# Config
FILENAME = r"C:\Users\welcome\Desktop\New folder\AML-Based-2D-System\sample_shapes_in_box.dxf"
OUTPUT = r"C:\Users\welcome\Desktop\New folder\AML-Based-2D-System\data\processed\test output\shapes_inside_rectangle_arranged.dxf"
SPACING = 4

# Load DXF
doc = ezdxf.readfile(FILENAME)
msp = doc.modelspace()

boundary = None
shapes = []

# STEP 1: Extract boundary + valid shapes (rectangle, square, circle only)
for entity in msp:
    if entity.dxftype() == "LWPOLYLINE" and entity.closed:
        pts = list(entity.get_points())
        xs = [p[0] for p in pts]
        ys = [p[1] for p in pts]
        w = max(xs) - min(xs)
        h = max(ys) - min(ys)

        if not boundary or w * h > boundary["width"] * boundary["height"]:
            boundary = {
                "entity": entity,
                "x": min(xs),
                "y": min(ys),
                "width": w,
                "height": h
            }
        else:
            shapes.append({
                "type": "square" if abs(w - h) < 0.1 else "rectangle",
                "width": w,
                "height": h
            })
    elif entity.dxftype() == "CIRCLE":
        r = entity.dxf.radius
        shapes.append({
            "type": "circle",
            "radius": r,
            "width": r * 2,
            "height": r * 2
        })

# STEP 2: Delete old shapes (except boundary)
for entity in list(msp):
    if entity != boundary["entity"]:
        msp.delete_entity(entity)

# STEP 3: Arrange shapes
current_x = boundary["x"] + SPACING
current_y = boundary["y"] + SPACING
row_max_height = 0

for shape in shapes:
    w, h = shape["width"], shape["height"]

    if current_x + w + SPACING > boundary["x"] + boundary["width"]:
        current_x = boundary["x"] + SPACING
        current_y += row_max_height + SPACING
        row_max_height = 0

    if current_y + h + SPACING > boundary["y"] + boundary["height"]:
        print(f"⚠️ Skipped shape {shape['type']} — no vertical space.")
        continue

    if shape["type"] == "circle":
        center = (current_x + shape["radius"], current_y + shape["radius"])
        msp.add_circle(center=center, radius=shape["radius"])
    else:
        msp.add_lwpolyline([
            (current_x, current_y),
            (current_x + w, current_y),
            (current_x + w, current_y + h),
            (current_x, current_y + h),
            (current_x, current_y)
        ], dxfattribs={"closed": True})

    current_x += w + SPACING
    row_max_height = max(row_max_height, h)

# STEP 4: Save file
doc.saveas(OUTPUT)
print(f"✅ Clean layout saved at: {OUTPUT}")
